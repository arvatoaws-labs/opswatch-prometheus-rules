name: Check Prometheus rules
on: [push]
jobs:
  check-rules:
    runs-on: ubuntu-latest
    steps:
      - run: echo "üéâ The job was automatically triggered by a ${{ github.event_name }} event."
      - run: echo "üêß This job is now running on a ${{ runner.os }} server hosted by GitHub!"
      - run: echo "üîé The name of your branch is ${{ github.ref }} and your repository is ${{ github.repository }}."
      - name: Check out repository code
        uses: actions/checkout@v3
      - run: echo "üí° The ${{ github.repository }} repository has been cloned to the runner."
      - run: echo "üñ•Ô∏è The workflow is now ready to test your code on the runner."
      - name: Install software
        run: |
          sudo apt-get update
          sudo apt-get install wget yamllint
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod 755 /usr/local/bin/yq
          wget -q https://github.com/prometheus/prometheus/releases/download/v2.36.2/prometheus-2.36.2.linux-amd64.tar.gz
          tar -xzf prometheus-2.36.2.linux-amd64.tar.gz
          sudo mv prometheus-2.36.2.linux-amd64/promtool /usr/local/bin/promtool
          rm -fr prometheus-2.36.2.linux-amd64.tar.gz
          rm -fr prometheus-2.36.2.linux-amd64
      - name: List files in the repository
        run: |
          ls ${{ github.workspace }}
      - name: Check files using yamllint
        run: |
          cd ${{ github.workspace }}
          yamllint --no-warnings rules/*.yaml
      - name: Convert files for promtool
        run: |
          cd ${{ github.workspace }}
          mkdir -p test/rules
          find rules -name "*.yaml"  | awk '{ print "cat " $1 " | yq .spec > test/"$1 }' | sh
          ls -la test/rules
      - name: Check files using promtool
        run: |
          cd ${{ github.workspace }}/test
          find . -name "*.yaml" -type f -exec promtool check rules {} \;
      - run: echo "üçè This job's status is ${{ job.status }}."
